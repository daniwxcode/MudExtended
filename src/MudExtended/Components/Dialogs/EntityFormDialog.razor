@using MudBlazor
@using MudExtended.Models.Configuration
@using MudExtended.Services.Localization
@typeparam TEntity
@typeparam TCreateCommand
@typeparam TUpdateCommand

<MudDialog>
<TitleContent>
    <MudText Typo="Typo.h6">@ComputedTitle</MudText>
</TitleContent>
<DialogContent>
        @if (_isLoading)
        {
            <div class="d-flex flex-column align-center pa-8">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
                <MudText Typo="Typo.body2" Class="mt-4">@Localization.GetString("EntityForm.Loading")</MudText>
            </div>
        }
        else if (_isSaving)
        {
            <div class="d-flex flex-column align-center pa-8">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
                <MudText Typo="Typo.body2" Class="mt-4">@Localization.GetString("EntityForm.Saving")</MudText>
            </div>
        }
        else
        {
            <MudForm @ref="_form" @bind-IsValid="_isFormValid">
                <div class="pa-4">
                    @if (FormContent is not null)
                    {
                        @FormContent(_currentModel!)
                    }
                    
                    @if (!string.IsNullOrWhiteSpace(_errorMessage))
                    {
                        <MudAlert Severity="Severity.Error" Class="mt-4">@_errorMessage</MudAlert>
                    }
                </div>
            </MudForm>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text" Disabled="@_isSaving">
            @Localization.GetString("Dialog.CancelButton")
        </MudButton>
        <MudButton OnClick="Submit" 
                   Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   Disabled="@(!_isFormValid || _isSaving || _isLoading)">
            @(IsCreate ? ResolvedCreateButtonText : ResolvedUpdateButtonText)
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
[CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Inject]
    private ISnackbar Snackbar { get; set; } = default!;

    [Inject]
    private MudExtendedOptions Options { get; set; } = default!;

    [Inject]
    private ILocalizationService Localization { get; set; } = default!;

    #region Parameters

    /// <summary>
    /// Create or edit mode.
    /// </summary>
    [Parameter, EditorRequired]
    public bool IsCreate { get; set; }

    /// <summary>
    /// Entity to edit (edit mode).
    /// </summary>
    [Parameter]
    public TEntity? Entity { get; set; }

    /// <summary>
    /// Entity ID (edit mode).
    /// </summary>
    [Parameter]
    public object? EntityId { get; set; }

    /// <summary>
    /// Create function.
    /// </summary>
    [Parameter, EditorRequired]
    public Func<TCreateCommand, Task<TEntity>> CreateFunc { get; set; } = default!;

    /// <summary>
    /// Update function.
    /// </summary>
    [Parameter, EditorRequired]
    public Func<object, TUpdateCommand, Task<TEntity>> UpdateFunc { get; set; } = default!;

    /// <summary>
    /// Factory to create a create command.
    /// </summary>
    [Parameter, EditorRequired]
    public Func<TCreateCommand> MapToCreate { get; set; } = default!;

    /// <summary>
    /// Map entity to update command.
    /// </summary>
    [Parameter, EditorRequired]
    public Func<TEntity, TUpdateCommand> MapToUpdate { get; set; } = default!;

    /// <summary>
    /// Form content.
    /// </summary>
    [Parameter, EditorRequired]
    public RenderFragment<object> FormContent { get; set; } = default!;

    /// <summary>
    /// Dialog title (auto-generated if null).
    /// </summary>
    [Parameter]
    public string? Title { get; set; }

    /// <summary>
    /// Create title prefix.
    /// </summary>
    [Parameter]
    public string? CreateTitle { get; set; }

    /// <summary>
    /// Edit title prefix.
    /// </summary>
    [Parameter]
    public string? EditTitle { get; set; }

    /// <summary>
    /// Entity name for title.
    /// </summary>
    [Parameter]
    public string EntityName { get; set; } = "";

    /// <summary>
    /// Success message.
    /// </summary>
    [Parameter]
    public string? SuccessMessage { get; set; }

    /// <summary>
    /// Create button text.
    /// </summary>
    [Parameter]
    public string? CreateButtonText { get; set; }

    /// <summary>
    /// Update button text.
    /// </summary>
    [Parameter]
    public string? UpdateButtonText { get; set; }

    private string ResolvedCreateTitle => CreateTitle ?? Localization.GetString("EntityForm.CreateTitle");
    private string ResolvedEditTitle => EditTitle ?? Localization.GetString("EntityForm.EditTitle");
    private string ResolvedCreateButtonText => CreateButtonText ?? Localization.GetString("EntityForm.CreateButton");
    private string ResolvedUpdateButtonText => UpdateButtonText ?? Localization.GetString("EntityForm.SaveButton");

    /// <summary>
    /// Event after successful save.
    /// </summary>
    [Parameter]
    public EventCallback<TEntity?> OnSuccess { get; set; }

    /// <summary>
    /// Cancel event.
    /// </summary>
    [Parameter]
    public EventCallback OnCancel { get; set; }

    #endregion

    #region Private Fields

    private MudForm? _form;
    private object? _currentModel;
    private bool _isFormValid;
    private bool _isLoading;
    private bool _isSaving;
    private string? _errorMessage;

    #endregion

    /// <summary>
    /// Computed dialog title.
    /// </summary>
    private string ComputedTitle
    {
        get
        {
            if (!string.IsNullOrWhiteSpace(Title))
                return Title;

            var prefix = IsCreate ? ResolvedCreateTitle : ResolvedEditTitle;
            return string.IsNullOrWhiteSpace(EntityName)
                ? prefix
                : $"{prefix} {EntityName}";
        }
    }

    /// <inheritdoc/>
    protected override void OnInitialized()
    {
        InitializeModel();
    }

    private void InitializeModel()
    {
        if (IsCreate)
        {
            _currentModel = MapToCreate();
        }
        else if (Entity is not null)
        {
            _currentModel = MapToUpdate(Entity);
        }
    }

    private async Task Submit()
    {
        if (_form is not null)
        {
            await _form.Validate();
            if (!_isFormValid) return;
        }

        _errorMessage = null;
        _isSaving = true;
        StateHasChanged();

        try
        {
            TEntity result;

            if (IsCreate && _currentModel is TCreateCommand createCmd)
            {
                result = await CreateFunc(createCmd);
            }
            else if (!IsCreate && _currentModel is TUpdateCommand updateCmd && EntityId is not null)
            {
                result = await UpdateFunc(EntityId, updateCmd);
            }
            else
            {
                throw new InvalidOperationException(Localization.GetString("EntityForm.InvalidConfig"));
            }

            var message = SuccessMessage ?? (IsCreate ? Localization.GetString("EntityForm.SuccessCreate") : Localization.GetString("EntityForm.SuccessUpdate"));
            Snackbar.Add(message, Severity.Success);

            await OnSuccess.InvokeAsync(result);
            MudDialog.Close(DialogResult.Ok(result));
        }
        catch (HttpRequestException ex)
        {
            _errorMessage = Localization.GetString("EntityForm.Error", ex.Message);
        }
        catch (Exception ex)
        {
            _errorMessage = Localization.GetString("EntityForm.UnexpectedError", ex.Message);
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        OnCancel.InvokeAsync();
        MudDialog.Cancel();
    }
}
